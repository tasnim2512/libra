# Libra DB åŒ…

Libra DB æ˜¯ä¸€ä¸ªä¸“æ³¨äºæ•°æ®åº“ç®¡ç†çš„ç°ä»£åŒ–æ ¸å¿ƒåŒ…ï¼Œä¸ºæ•´ä¸ªåº”ç”¨æä¾›ç»Ÿä¸€ã€ç±»å‹å®‰å…¨çš„ä¸šåŠ¡æ•°æ®è®¿é—®å±‚ã€‚è¯¥åŒ…åŸºäº **Drizzle ORM** æ„å»ºï¼Œå®ç°äº†å®Œå…¨ç±»å‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œï¼Œå¹¶é’ˆå¯¹ **Cloudflare** ç¯å¢ƒè¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–ã€‚å®ƒæä¾›æ™ºèƒ½çš„ç¯å¢ƒé€‚åº”æ€§è¿æ¥è§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿåœ¨å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä¹‹é—´æ— ç¼åˆ‡æ¢ï¼ŒåŒæ—¶åˆ©ç”¨ Cloudflare Hyperdrive æŠ€æœ¯æ˜¾è‘—æå‡ Serverless åœºæ™¯ä¸‹çš„æ•°æ®åº“æ€§èƒ½ã€‚é€šè¿‡é›†ä¸­ç®¡ç†çš„æ•°æ®æ¨¡å‹å®šä¹‰å’Œ React ç¼“å­˜æœºåˆ¶ï¼Œç¡®ä¿æ•´ä¸ªåº”ç”¨ä½¿ç”¨ä¸€è‡´çš„æ•°æ®ç»“æ„ï¼Œå¹¶æœ‰æ•ˆé˜²æ­¢èµ„æºæµªè´¹å’Œè¿æ¥æ³„æ¼ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ ç±»å‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œ
- **Drizzle ORM é›†æˆ**ï¼šå®Œå…¨ç±»å‹å®‰å…¨çš„æ•°æ®åº“æŸ¥è¯¢å’Œæ“ä½œ
- **è‡ªåŠ¨ç±»å‹æ¨æ–­**ï¼šä» schema è‡ªåŠ¨ç”Ÿæˆ TypeScript ç±»å‹
- **ç¼–è¯‘æ—¶æ£€æŸ¥**ï¼šåœ¨ç¼–è¯‘é˜¶æ®µå‘ç° SQL é”™è¯¯å’Œç±»å‹ä¸åŒ¹é…
- **IntelliSense æ”¯æŒ**ï¼šå®Œæ•´çš„ä»£ç è¡¥å…¨å’Œç±»å‹æç¤º

### âš¡ é«˜æ€§èƒ½æ•°æ®åº“è¿æ¥
- **Cloudflare Hyperdrive**ï¼šç”Ÿäº§ç¯å¢ƒä¸‹çš„æ•°æ®åº“è¿æ¥åŠ é€Ÿ
- **è¿æ¥æ± ç®¡ç†**ï¼šæ™ºèƒ½çš„ PostgreSQL è¿æ¥æ± é…ç½®
- **React ç¼“å­˜ä¼˜åŒ–**ï¼šé˜²æ­¢é‡å¤è¿æ¥åˆ›å»ºï¼Œæå‡æ€§èƒ½
- **Serverless ä¼˜åŒ–**ï¼šä¸“ä¸º Serverless ç¯å¢ƒè®¾è®¡çš„è¿æ¥ç­–ç•¥

### ğŸ”„ ç¯å¢ƒé€‚åº”æ€§
- **è‡ªåŠ¨ç¯å¢ƒæ£€æµ‹**ï¼šæ™ºèƒ½è¯†åˆ«å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒ
- **é…ç½®ç»Ÿä¸€**ï¼šç›¸åŒä»£ç åœ¨ä¸åŒç¯å¢ƒä¸‹è‡ªåŠ¨é€‚é…
- **çƒ­åˆ‡æ¢æ”¯æŒ**ï¼šæ— éœ€é‡å¯å³å¯åˆ‡æ¢æ•°æ®åº“è¿æ¥
- **ç¯å¢ƒéš”ç¦»**ï¼šç¡®ä¿å¼€å‘å’Œç”Ÿäº§æ•°æ®çš„å®Œå…¨éš”ç¦»

### ğŸ§© æ¨¡å—åŒ–æ¶æ„
- **Schema åˆ†ç¦»**ï¼šæŒ‰ä¸šåŠ¡é¢†åŸŸåˆ†ç¦»æ•°æ®æ¨¡å‹å®šä¹‰
- **é¢†åŸŸé©±åŠ¨**ï¼šé¡¹ç›®ã€ç»„ä»¶ã€è®¢é˜…ç­‰ç‹¬ç«‹æ¨¡å—
- **æ‰©å±•æ€§å¼º**ï¼šæ˜“äºæ·»åŠ æ–°çš„ä¸šåŠ¡é¢†åŸŸå’Œæ•°æ®æ¨¡å‹
- **ä¾èµ–ç®¡ç†**ï¼šæ¸…æ™°çš„æ¨¡å—é—´ä¾èµ–å…³ç³»

### ğŸ›¡ï¸ ä¼ä¸šçº§åŠŸèƒ½
- **æ•°æ®è¿ç§»**ï¼šå®Œæ•´çš„æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶å’Œè¿ç§»ç®¡ç†
- **æ€§èƒ½ç›‘æ§**ï¼šæ•°æ®åº“è¿æ¥å’ŒæŸ¥è¯¢æ€§èƒ½è¿½è¸ª
- **å®‰å…¨æ€§**ï¼šSQL æ³¨å…¥é˜²æŠ¤å’Œæƒé™æ§åˆ¶
- **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´çš„æ•°æ®å˜æ›´è¿½è¸ªè®°å½•

## ğŸ“ é¡¹ç›®ç»“æ„

```bash
packages/db/
â”œâ”€â”€ DEV-ZH.md                 # ä¸­æ–‡å¼€å‘æ–‡æ¡£
â”œâ”€â”€ DEV.md                    # è‹±æ–‡å¼€å‘æ–‡æ¡£
â”œâ”€â”€ README.md                 # åŒ…è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ package.json              # åŒ…ä¾èµ–ä¸è„šæœ¬å®šä¹‰
â”œâ”€â”€ tsconfig.json             # TypeScript é…ç½®
â”œâ”€â”€ tsup.config.ts            # æ„å»ºé…ç½®
â”œâ”€â”€ env.mjs                   # ç¯å¢ƒå˜é‡é…ç½®ä¸éªŒè¯
â”œâ”€â”€ drizzle.config.ts         # Drizzle ORM é…ç½®
â”œâ”€â”€ index.ts                  # ä¸»è¦å¯¼å‡ºæ–‡ä»¶
â”œâ”€â”€ cloudflare-env.d.ts       # Cloudflare ç¯å¢ƒç±»å‹å®šä¹‰
â”œâ”€â”€ custom-domain-queries.ts  # è‡ªå®šä¹‰åŸŸåæŸ¥è¯¢å‡½æ•°
â”œâ”€â”€ drizzle/                  # Drizzle ORM å…ƒæ•°æ®
â”‚   â”œâ”€â”€ 0000_*.sql           # æ•°æ®åº“è¿ç§» SQL æ–‡ä»¶
â”‚   â””â”€â”€ meta/                 # è¿ç§»å…ƒæ•°æ®å’Œç‰ˆæœ¬ä¿¡æ¯
â”‚       â”œâ”€â”€ 0000_snapshot.json # æ•°æ®åº“ç»“æ„å¿«ç…§
â”‚       â””â”€â”€ _journal.json     # è¿ç§»å†å²è®°å½•
â”œâ”€â”€ schema/                   # æ•°æ®åº“æ¨¡å¼å®šä¹‰
â”‚   â”œâ”€â”€ project-schema.ts     # é¡¹ç›®ç›¸å…³è¡¨ç»“æ„å®šä¹‰
â”‚   â””â”€â”€ components-schema.ts  # ç»„ä»¶ç›¸å…³è¡¨ç»“æ„å®šä¹‰
â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
    â””â”€â”€ subscription.ts       # è®¢é˜…ç›¸å…³å·¥å…·å‡½æ•°
```

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **Drizzle ORM**ï¼šç°ä»£ TypeScript ORMï¼Œæä¾›ç±»å‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œ
- **PostgreSQL**ï¼šä¼ä¸šçº§å…³ç³»å‹æ•°æ®åº“
- **Cloudflare Hyperdrive**ï¼šæ•°æ®åº“è¿æ¥åŠ é€ŸæœåŠ¡
- **React Cache**ï¼šæœåŠ¡å™¨ç«¯ç»„ä»¶ç¼“å­˜æœºåˆ¶
- **Node.js pg**ï¼šé«˜æ€§èƒ½ PostgreSQL å®¢æˆ·ç«¯

### æ¶æ„è®¾è®¡
- **è¿æ¥å±‚æŠ½è±¡**ï¼šç»Ÿä¸€çš„æ•°æ®åº“è¿æ¥æ¥å£
- **ç¯å¢ƒé€‚é…**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œé€‚é…ä¸åŒéƒ¨ç½²ç¯å¢ƒ
- **ç¼“å­˜ç­–ç•¥**ï¼šå¤šå±‚æ¬¡çš„æ•°æ®åº“è¿æ¥å’ŒæŸ¥è¯¢ç¼“å­˜
- **ç±»å‹ç³»ç»Ÿ**ï¼šç«¯åˆ°ç«¯çš„ TypeScript ç±»å‹å®‰å…¨

## ğŸš€ å®‰è£…ä¸é…ç½®

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆ.env.localï¼‰
POSTGRES_URL=postgresql://username:password@localhost:5432/libra_dev

# ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆCloudflareï¼‰
# HYPERDRIVE è¿æ¥å°†è‡ªåŠ¨é€šè¿‡ Cloudflare ç¯å¢ƒæä¾›
```

### æ•°æ®åº“åˆå§‹åŒ–

```bash
# å®‰è£…ä¾èµ–
bun install

# ç”Ÿæˆè¿ç§»æ–‡ä»¶
bun db:generate

# æ‰§è¡Œæ•°æ®åº“è¿ç§»
bun db:migrate

# æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€
bun db:status
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### æ•°æ®åº“è¿æ¥ç®¡ç†

```typescript
// å¼‚æ­¥æ•°æ®åº“è¿æ¥ï¼ˆç”¨äº Next.js åº”ç”¨ï¼‰
import { getDbAsync } from '@libra/db'

export async function GET() {
  const db = await getDbAsync()
  const projects = await db.select().from(project)
  return Response.json(projects)
}

// Hono åº”ç”¨æ•°æ®åº“è¿æ¥ï¼ˆç”¨äº Cloudflare Workersï¼‰
import { getDbForHono } from '@libra/db'

export async function handler(c: Context) {
  const db = await getDbForHono(c)
  const projects = await db.select().from(project)
  return c.json(projects)
}

// Workflow åº”ç”¨æ•°æ®åº“è¿æ¥
import { getDbForWorkflow } from '@libra/db'

export async function workflowHandler(env: any) {
  const db = await getDbForWorkflow(env)
  const projects = await db.select().from(project)
  return projects
}
```

### ç±»å‹å®‰å…¨çš„æŸ¥è¯¢æ“ä½œ

```typescript
import { getDbAsync, project, projectAIUsage } from '@libra/db'
import { eq, and, desc } from 'drizzle-orm'

// æŸ¥è¯¢é¡¹ç›®
const db = await getDbAsync()

// åˆ›å»ºæ–°é¡¹ç›®
const newProject = await db.insert(project).values({
  name: 'æˆ‘çš„æ–°é¡¹ç›®',
  templateType: 'nextjs',
  userId: 'user_123',
  organizationId: 'org_456',
  visibility: 'private'
}).returning()

// æŸ¥è¯¢ç”¨æˆ·é¡¹ç›®
const userProjects = await db
  .select()
  .from(project)
  .where(and(
    eq(project.userId, 'user_123'),
    eq(project.isActive, true)
  ))
  .orderBy(desc(project.createdAt))

// è”è¡¨æŸ¥è¯¢é¡¹ç›®å’Œä½¿ç”¨æƒ…å†µ
const projectsWithUsage = await db
  .select({
    project: project,
    usage: projectAIUsage
  })
  .from(project)
  .leftJoin(projectAIUsage, eq(project.id, projectAIUsage.projectId))
  .where(eq(project.organizationId, 'org_456'))
```

### äº‹åŠ¡æ“ä½œ

```typescript
import { getDbAsync } from '@libra/db'

const db = await getDbAsync()

// äº‹åŠ¡ï¼šåˆ›å»ºé¡¹ç›®å¹¶åˆå§‹åŒ–ä½¿ç”¨è®°å½•
await db.transaction(async (tx) => {
  // åˆ›å»ºé¡¹ç›®
  const [newProject] = await tx.insert(project).values({
    name: 'æ–°é¡¹ç›®',
    templateType: 'nextjs',
    userId: 'user_123',
    organizationId: 'org_456'
  }).returning()

  // åˆå§‹åŒ– AI ä½¿ç”¨è®°å½•
  await tx.insert(projectAIUsage).values({
    projectId: newProject.id,
    organizationId: 'org_456',
    totalAIMessageCount: 0
  })
})
```

## ğŸ“Š æ•°æ®æ¨¡å‹

### é¡¹ç›®ç®¡ç†æ¨¡å—

#### Project è¡¨
é¡¹ç›®çš„æ ¸å¿ƒä¿¡æ¯ç®¡ç†è¡¨ã€‚

```typescript
export const project = pgTable('project', {
  id: text('id').primaryKey().unique(),          // é¡¹ç›®å”¯ä¸€æ ‡è¯†
  name: text('name').notNull(),                  // é¡¹ç›®åç§°
  templateType: text('template_type').notNull(), // æ¨¡æ¿ç±»å‹
  url: text('url'),                              // é¡¹ç›®è®¿é—® URL
  gitUrl: text('git_url'),                       // Git ä»“åº“åœ°å€
  gitBranch: text('git_branch'),                 // Git åˆ†æ”¯
  previewImageUrl: text('preview_image_url'),    // é¢„è§ˆå›¾ç‰‡ URL
  productionDeployUrl: text('production_deploy_url'), // ç”Ÿäº§éƒ¨ç½² URL
  workflowId: text('workflow_id'),               // å·¥ä½œæµ ID
  deploymentStatus: varchar('deployment_status', { // éƒ¨ç½²çŠ¶æ€
    enum: ['idle', 'preparing', 'deploying', 'deployed', 'failed']
  }).default('idle'),
  customDomain: text('custom_domain'),           // è‡ªå®šä¹‰åŸŸå
  customDomainStatus: varchar('custom_domain_status', { // è‡ªå®šä¹‰åŸŸåçŠ¶æ€
    enum: ['pending', 'verified', 'active', 'failed']
  }),
  customDomainVerifiedAt: timestamp('custom_domain_verified_at'), // è‡ªå®šä¹‰åŸŸåéªŒè¯æ—¶é—´
  customHostnameId: text('custom_hostname_id'),  // è‡ªå®šä¹‰ä¸»æœºå ID
  ownershipVerification: text('ownership_verification'), // æ‰€æœ‰æƒéªŒè¯
  sslStatus: varchar('ssl_status', {             // SSL çŠ¶æ€
    enum: ['pending', 'pending_validation', 'active', 'failed']
  }),
  visibility: varchar('visibility', { enum: ['public', 'private'] }), // å¯è§æ€§
  isActive: boolean('is_active').default(true),  // æ˜¯å¦æ´»è·ƒ
  userId: text('user_id').notNull(),             // ç”¨æˆ· ID
  organizationId: text('organization_id').notNull(), // ç»„ç»‡ ID
  containerId: text('container_id'),             // å®¹å™¨ ID
  initialMessage: text('initial_message'),       // åˆå§‹æ¶ˆæ¯
  knowledge: text('knowledge'),                  // çŸ¥è¯†åº“å†…å®¹
  messageHistory: text('message_history').default('[]'), // æ¶ˆæ¯å†å²
  createdAt: timestamp('created_at'),            // åˆ›å»ºæ—¶é—´
  updatedAt: timestamp('updated_at')             // æ›´æ–°æ—¶é—´
})

// TypeScript ç±»å‹
type Project = typeof project.$inferSelect
type InsertProject = typeof project.$inferInsert
```

#### ProjectAIUsage è¡¨
é¡¹ç›® AI åŠŸèƒ½ä½¿ç”¨ç»Ÿè®¡è¡¨ã€‚

```typescript
export const projectAIUsage = pgTable('project_ai_usage', {
  id: text('id').primaryKey(),                   // è®°å½•å”¯ä¸€æ ‡è¯†
  projectId: text('project_id').references(() => project.id), // é¡¹ç›® IDï¼ˆå¤–é”®ï¼‰
  organizationId: text('organization_id').notNull(), // ç»„ç»‡ ID
  totalAIMessageCount: integer('total_ai_message_count').default(0), // æ€» AI æ¶ˆæ¯æ•°
  lastUsedAt: timestamp('last_used_at'),         // æœ€åä½¿ç”¨æ—¶é—´
  createdAt: timestamp('created_at'),            // åˆ›å»ºæ—¶é—´
  updatedAt: timestamp('updated_at')             // æ›´æ–°æ—¶é—´
})
```

### è®¢é˜…ç®¡ç†æ¨¡å—

#### SubscriptionLimit è¡¨
ç»„ç»‡è®¢é˜…é™åˆ¶å’Œè®¡è´¹ä¿¡æ¯ç®¡ç†è¡¨ã€‚

```typescript
export const subscriptionLimit = pgTable('subscription_limit', {
  id: text('id').primaryKey(),                   // è®°å½•å”¯ä¸€æ ‡è¯†
  organizationId: text('organization_id').notNull(), // ç»„ç»‡ ID
  stripeCustomerId: text('stripe_customer_id'),  // Stripe å®¢æˆ· ID
  planName: text('plan_name').notNull(),         // è®¢é˜…è®¡åˆ’åç§°
  planId: text('plan_id').notNull(),             // è®¢é˜…è®¡åˆ’ ID
  aiNums: integer('ai_nums').notNull(),          // AI ä½¿ç”¨æ¬¡æ•°é™åˆ¶
  enhanceNums: integer('enhance_nums').notNull(), // å¢å¼ºåŠŸèƒ½æ¬¡æ•°é™åˆ¶
  uploadLimit: integer('upload_limit').notNull(), // ä¸Šä¼ é™åˆ¶
  deployLimit: integer('deploy_limit').notNull(), // éƒ¨ç½²é™åˆ¶
  seats: integer('seats').default(1),           // å¸­ä½æ•°
  projectNums: integer('project_nums').default(1), // é¡¹ç›®æ•°é™åˆ¶
  isActive: boolean('is_active').default(true), // æ˜¯å¦æ´»è·ƒ
  periodStart: timestamp('period_start'),       // è®¢é˜…å‘¨æœŸå¼€å§‹
  periodEnd: timestamp('period_end'),           // è®¢é˜…å‘¨æœŸç»“æŸ
  createdAt: timestamp('created_at'),           // åˆ›å»ºæ—¶é—´
  updatedAt: timestamp('updated_at')            // æ›´æ–°æ—¶é—´
}, (table) => ({
  // å”¯ä¸€çº¦æŸï¼šæ¯ä¸ªç»„ç»‡åªèƒ½æœ‰ä¸€ä¸ªæ´»è·ƒçš„è®¡åˆ’
  uniqueOrgPlanActive: uniqueIndex('subscription_limit_org_plan_active_idx')
    .on(table.organizationId, table.planName)
    .where(sql`${table.isActive} = true`)
}))
```

### ç»„ä»¶ç®¡ç†æ¨¡å—

#### Components è¡¨
UI ç»„ä»¶åº“ç®¡ç†è¡¨ã€‚

```typescript
export const components = pgTable('components', {
  id: integer('id').primaryKey(),                // ç»„ä»¶å”¯ä¸€æ ‡è¯†
  name: text('name').notNull(),                  // ç»„ä»¶åç§°
  component_slug: text('component_slug').unique(), // ç»„ä»¶ slug
  code: text('code'),                            // ç»„ä»¶ä»£ç 
  compiled_css: text('compiled_css'),            // ç¼–è¯‘åçš„ CSS
  component_names: json('component_names').notNull(), // ç»„ä»¶åç§°åˆ—è¡¨
  demo_code: text('demo_code'),                  // æ¼”ç¤ºä»£ç 
  demo_dependencies: json('demo_dependencies'),  // æ¼”ç¤ºä¾èµ–
  demo_direct_registry_dependencies: json('demo_direct_registry_dependencies'), // æ¼”ç¤ºç›´æ¥æ³¨å†Œä¾èµ–
  dependencies: json('dependencies'),            // ä¾èµ–åˆ—è¡¨
  direct_registry_dependencies: json('direct_registry_dependencies'), // ç›´æ¥æ³¨å†Œä¾èµ–
  description: text('description'),              // ç»„ä»¶æè¿°
  global_css_extension: text('global_css_extension'), // å…¨å±€ CSS æ‰©å±•
  tailwind_config_extension: text('tailwind_config_extension'), // Tailwind é…ç½®æ‰©å±•
  downloads_count: integer('downloads_count').default(0), // ä¸‹è½½æ¬¡æ•°
  likes_count: integer('likes_count').default(0), // ç‚¹èµæ¬¡æ•°
  is_public: boolean('is_public').default(false), // æ˜¯å¦å…¬å¼€
  is_paid: boolean('is_paid').default(false),   // æ˜¯å¦ä»˜è´¹
  payment_url: text('payment_url'),              // ä»˜è´¹ URL
  preview_url: text('preview_url').notNull(),   // é¢„è§ˆ URL
  created_at: timestamp('created_at'),          // åˆ›å»ºæ—¶é—´
  updated_at: timestamp('updated_at')           // æ›´æ–°æ—¶é—´
})
```

#### ProjectAsset è¡¨
é¡¹ç›®èµ„äº§æ–‡ä»¶ç®¡ç†è¡¨ï¼Œç”¨äºè·Ÿè¸ªé¡¹ç›®ç›¸å…³çš„é™„ä»¶æ–‡ä»¶ã€‚

```typescript
export const projectAsset = pgTable('project_asset', {
  id: text('id').primaryKey(),                   // èµ„äº§å”¯ä¸€æ ‡è¯†
  organizationId: text('organization_id').notNull(), // ç»„ç»‡ ID
  projectId: text('project_id')                  // é¡¹ç›® IDï¼ˆå¤–é”®ï¼‰
    .notNull()
    .references(() => project.id, { onDelete: 'cascade' }),
  planId: text('plan_id').notNull(),             // è®¡åˆ’ ID
  attachmentKey: text('attachment_key').notNull(), // é™„ä»¶é”®
  createdAt: timestamp('created_at'),            // åˆ›å»ºæ—¶é—´
  updatedAt: timestamp('updated_at')             // æ›´æ–°æ—¶é—´
})
```

### å·¥å…·å‡½æ•°æ¨¡å—

#### è‡ªå®šä¹‰åŸŸåæŸ¥è¯¢
æä¾›è‡ªå®šä¹‰åŸŸåç›¸å…³çš„æ•°æ®åº“æŸ¥è¯¢åŠŸèƒ½ã€‚

```typescript
import { findProjectByCustomDomain, validateCustomDomainProject } from '@libra/db'

// æ ¹æ®è‡ªå®šä¹‰åŸŸåæŸ¥æ‰¾é¡¹ç›®
const result = await findProjectByCustomDomain(db, 'example.com')
if (result.success && result.project) {
  // éªŒè¯åŸŸåé…ç½®
  const validation = validateCustomDomainProject(result.project)
  if (validation.valid) {
    // åŸŸåé…ç½®æ­£ç¡®ï¼Œå¯ä»¥ä½¿ç”¨
  }
}
```

#### è®¢é˜…å·¥å…·å‡½æ•°
æä¾›è®¢é˜…ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å‡½æ•°ã€‚

```typescript
import { hasPremiumMembership } from '@libra/db'

// æ£€æŸ¥ç»„ç»‡æ˜¯å¦æœ‰é«˜çº§ä¼šå‘˜èµ„æ ¼
const isPremium = await hasPremiumMembership('org_123')
if (isPremium) {
  // å…è®¸è®¿é—®é«˜çº§åŠŸèƒ½
}
```

## ğŸ”§ å¼€å‘æŒ‡å—

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

```bash
# å¯åŠ¨æœ¬åœ° PostgreSQL æ•°æ®åº“
docker run --name libra-postgres \
  -e POSTGRES_DB=libra_dev \
  -e POSTGRES_USER=libra \
  -e POSTGRES_PASSWORD=password \
  -p 5432:5432 \
  -d postgres:15

# è®¾ç½®ç¯å¢ƒå˜é‡
export POSTGRES_URL="postgresql://libra:password@localhost:5432/libra_dev"

# è¿è¡Œè¿ç§»
bun db:migrate
```

### æ·»åŠ æ–°çš„æ•°æ®è¡¨

1. **åˆ›å»º Schema æ–‡ä»¶**

```typescript
// schema/user-schema.ts
import { pgTable, text, timestamp, boolean } from 'drizzle-orm/pg-core'
import { createId } from '@paralleldrive/cuid2'

export const user = pgTable('user', {
  id: text('id').$defaultFn(() => createId()).primaryKey(),
  email: text('email').notNull().unique(),
  name: text('name').notNull(),
  avatar: text('avatar'),
  isActive: boolean('is_active').default(true),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow().$onUpdate(() => new Date())
})

export type User = typeof user.$inferSelect
export type InsertUser = typeof user.$inferInsert
```

2. **æ›´æ–°ä¸»å¯¼å‡ºæ–‡ä»¶**

```typescript
// index.ts
import * as userSchema from './schema/user-schema'

export const schema = { 
  ...projectSchema, 
  ...components,
  ...userSchema  // æ·»åŠ æ–°çš„ schema
}
```

3. **ç”Ÿæˆå’Œæ‰§è¡Œè¿ç§»**

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
bun db:generate

# æ‰§è¡Œè¿ç§»
bun db:migrate
```

### æ•°æ®åº“æŸ¥è¯¢æœ€ä½³å®è·µ

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ç±»å‹å®‰å…¨çš„æŸ¥è¯¢
import { eq, and, desc, count } from 'drizzle-orm'

// åˆ†é¡µæŸ¥è¯¢
async function getProjectsPaginated(organizationId: string, page = 1, limit = 10) {
  const db = await getDbAsync()
  
  const offset = (page - 1) * limit
  
  const [projects, totalCount] = await Promise.all([
    db
      .select()
      .from(project)
      .where(eq(project.organizationId, organizationId))
      .limit(limit)
      .offset(offset)
      .orderBy(desc(project.createdAt)),
    
    db
      .select({ count: count() })
      .from(project)
      .where(eq(project.organizationId, organizationId))
  ])
  
  return {
    projects,
    total: totalCount[0].count,
    page,
    limit,
    totalPages: Math.ceil(totalCount[0].count / limit)
  }
}

// âœ… æ¨èï¼šä½¿ç”¨äº‹åŠ¡å¤„ç†å¤æ‚æ“ä½œ
async function createProjectWithLimits(data: {
  name: string
  userId: string
  organizationId: string
}) {
  const db = await getDbAsync()
  
  return await db.transaction(async (tx) => {
    // æ£€æŸ¥é¡¹ç›®æ•°é‡é™åˆ¶
    const subscription = await tx
      .select()
      .from(subscriptionLimit)
      .where(and(
        eq(subscriptionLimit.organizationId, data.organizationId),
        eq(subscriptionLimit.isActive, true)
      ))
      .limit(1)
    
    if (!subscription.length) {
      throw new Error('æ— æœ‰æ•ˆè®¢é˜…')
    }
    
    const currentProjectCount = await tx
      .select({ count: count() })
      .from(project)
      .where(eq(project.organizationId, data.organizationId))
    
    if (currentProjectCount[0].count >= subscription[0].projectNums) {
      throw new Error('å·²è¾¾åˆ°é¡¹ç›®æ•°é‡é™åˆ¶')
    }
    
    // åˆ›å»ºé¡¹ç›®
    const [newProject] = await tx
      .insert(project)
      .values({
        name: data.name,
        userId: data.userId,
        organizationId: data.organizationId,
        templateType: 'nextjs'
      })
      .returning()
    
    // åˆå§‹åŒ–ä½¿ç”¨ç»Ÿè®¡
    await tx.insert(projectAIUsage).values({
      projectId: newProject.id,
      organizationId: data.organizationId
    })
    
    return newProject
  })
}
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

```typescript
// âœ… ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
// åœ¨é¢‘ç¹æŸ¥è¯¢çš„å­—æ®µä¸Šæ·»åŠ ç´¢å¼•
export const projectIndex = index('project_org_user_idx')
  .on(project.organizationId, project.userId)

// âœ… ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–ç‰¹å®šæŸ¥è¯¢
export const activeProjectIndex = index('active_project_idx')
  .on(project.organizationId)
  .where(eq(project.isActive, true))

// âœ… æ‰¹é‡æ“ä½œä¼˜åŒ–
async function bulkUpdateProjects(updates: Array<{id: string, name: string}>) {
  const db = await getDbAsync()
  
  // ä½¿ç”¨æ‰¹é‡æ›´æ–°è€Œä¸æ˜¯å¾ªç¯å•ç‹¬æ›´æ–°
  const promises = updates.map(update => 
    db
      .update(project)
      .set({ name: update.name, updatedAt: new Date() })
      .where(eq(project.id, update.id))
  )
  
  await Promise.all(promises)
}
```

## ğŸ¯ è§£å†³çš„é—®é¢˜

### 1. æ•°æ®åº“æ“ä½œç±»å‹å®‰å…¨
- **ä¼ ç»Ÿé—®é¢˜**ï¼šSQL æŸ¥è¯¢æ˜“å‡ºé”™ï¼Œç¼ºä¹ç±»å‹æ£€æŸ¥
- **è§£å†³æ–¹æ¡ˆ**ï¼šDrizzle ORM æä¾›ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- **ä¼˜åŠ¿**ï¼šå¼€å‘é˜¶æ®µå‘ç°é”™è¯¯ï¼Œå‡å°‘è¿è¡Œæ—¶å¼‚å¸¸

### 2. ç¯å¢ƒé…ç½®å¤æ‚æ€§
- **ä¼ ç»Ÿé—®é¢˜**ï¼šå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒé…ç½®ä¸ä¸€è‡´
- **è§£å†³æ–¹æ¡ˆ**ï¼šæ™ºèƒ½ç¯å¢ƒæ£€æµ‹å’Œè‡ªåŠ¨é€‚é…
- **ä¼˜åŠ¿**ï¼šç›¸åŒä»£ç å¤šç¯å¢ƒè¿è¡Œï¼Œé™ä½é…ç½®é”™è¯¯

### 3. æ•°æ®åº“è¿æ¥æ€§èƒ½
- **ä¼ ç»Ÿé—®é¢˜**ï¼šServerless ç¯å¢ƒä¸‹è¿æ¥å»¶è¿Ÿé«˜
- **è§£å†³æ–¹æ¡ˆ**ï¼šCloudflare Hyperdrive åŠ é€Ÿ
- **ä¼˜åŠ¿**ï¼šæ˜¾è‘—æå‡æ•°æ®åº“è®¿é—®æ€§èƒ½

### 4. æ•°æ®æ¨¡å‹ç»´æŠ¤
- **ä¼ ç»Ÿé—®é¢˜**ï¼šæ•°æ®æ¨¡å‹åˆ†æ•£ï¼Œç¼ºä¹ç»Ÿä¸€ç®¡ç†
- **è§£å†³æ–¹æ¡ˆ**ï¼šé›†ä¸­å¼ Schema å®šä¹‰å’Œç‰ˆæœ¬æ§åˆ¶
- **ä¼˜åŠ¿**ï¼šæ•°æ®ç»“æ„ä¸€è‡´æ€§ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

### 5. å¼€å‘æ•ˆç‡
- **ä¼ ç»Ÿé—®é¢˜**ï¼šæ•°æ®åº“æ“ä½œä»£ç é‡å¤ï¼Œç¼ºä¹æŠ½è±¡
- **è§£å†³æ–¹æ¡ˆ**ï¼šç»Ÿä¸€çš„æ•°æ®è®¿é—®å±‚å’Œå·¥å…·å‡½æ•°
- **ä¼˜åŠ¿**ï¼šæé«˜å¼€å‘æ•ˆç‡ï¼Œå‡å°‘é‡å¤ä»£ç 

## ğŸ“– ç›¸å…³èµ„æº

- **Drizzle ORM å®˜æ–¹æ–‡æ¡£**: [https://orm.drizzle.team/](https://orm.drizzle.team/)
- **Cloudflare Hyperdrive**: [https://developers.cloudflare.com/hyperdrive/](https://developers.cloudflare.com/hyperdrive/)
- **PostgreSQL æ–‡æ¡£**: [https://www.postgresql.org/docs/](https://www.postgresql.org/docs/)
- **React Cache API**: [https://react.dev/reference/react/cache](https://react.dev/reference/react/cache)

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç å’Œå»ºè®®ï¼

### è´¡çŒ®æ–¹å¼
- ğŸ› **Bug æŠ¥å‘Š**ï¼šå‘ç°é—®é¢˜è¯·æäº¤ Issue
- ğŸ’¡ **åŠŸèƒ½å»ºè®®**ï¼šæ–°åŠŸèƒ½æƒ³æ³•æ¬¢è¿è®¨è®º
- ğŸ“ **æ–‡æ¡£æ”¹è¿›**ï¼šå¸®åŠ©å®Œå–„æ–‡æ¡£å†…å®¹
- ğŸ”§ **ä»£ç è´¡çŒ®**ï¼šæäº¤ Pull Request

### å¼€å‘æµç¨‹
1. Fork é¡¹ç›®ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. å¼€å‘å’Œæµ‹è¯•
4. æäº¤ Pull Request
5. ä»£ç å®¡æŸ¥å’Œåˆå¹¶

### Schema è´¡çŒ®æŒ‡å—
- éµå¾ªç°æœ‰çš„å‘½åçº¦å®šå’Œä»£ç é£æ ¼
- æ·»åŠ å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- æä¾›è¯¦ç»†çš„å­—æ®µæ³¨é‡Šå’Œä½¿ç”¨è¯´æ˜
- ç¡®ä¿è¿ç§»æ–‡ä»¶çš„å‘åå…¼å®¹æ€§
